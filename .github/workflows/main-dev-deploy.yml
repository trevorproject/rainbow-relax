name: Main Dev Deploy

on:
  push:
    branches: [main]

env:
  DEV_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev/

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build widget
        run: npm run build:widget

      - name: Create dev HTML page
        run: |
          cat > dist-widget/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Rainbow Relax - Dev Environment</title>
            <meta name="description" content="Development version of the Rainbow Relax breathing exercise widget">
            <style>
              body {
                margin: 0;
                padding: 0;
                font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
              }
              .widget-container {
                width: 100vw;
                height: 100vh;
                background: #F3E9DC;
                border-radius: 0;
                box-shadow: 0 0 30px rgba(0,0,0,0.15);
                overflow: hidden;
                position: relative;
              }
              .dev-banner {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(90deg, #2196F3, #1976D2);
                color: white;
                text-align: center;
                padding: 8px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
              }
            </style>
          </head>
          <body class="fullscreen-widget">
            <div class="dev-banner">ðŸš€ Dev Environment - Latest from Main Branch</div>
            <div class="widget-container">
              <div id="rainbow-relax-container" style="width: 100%; height: 100%;"></div>
            </div>

            <script>
              (function (w, d, s, src, id) {
                if (d.getElementById(id)) return;
                var js = d.createElement(s);
                js.id = id;
                js.src = src;
                js.async = true;
                d.head.appendChild(js);
              })(
                window,
                document,
                'script',
                './rainbowRelax.js',
                'rainbow-relax'
              );

              window.myWidgetConfig = {
                showQuickExit: false,
                donateURL: 'https://www.paypal.com/donate/?hosted_button_id=G5E9W3NZ8D7WW',
                getHelpURL: 'https://www.thetrevorproject.mx/ayuda/',
                width: '100%',
                height: '100%',
                containerId: 'rainbow-relax-container',
                cdnBase: './assets/',
                audioEnabled: true,
                debug: true,
                showConsentBanner: false
              };
            </script>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages (Dev)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist-widget
          destination_dir: dev

      - name: Create Release Artifact
        run: |
          # Create a release artifact with the widget files
          mkdir -p release-artifact
          cp -r dist-widget/* release-artifact/

          # Create integration instructions
          cat > release-artifact/INTEGRATION.md << 'EOF'
          # Rainbow Relax Widget Integration

          ## Quick Integration

          Add this code to your HTML page:

          ```html
          <div id="rainbow-relax-container" style="width: 500px; height: 500px;"></div>
          <script>
            (function(w, d, s, src, id) {
              if (d.getElementById(id)) return;
              var js = d.createElement(s);
              js.id = id;
              js.src = src;
              js.async = true;
              d.head.appendChild(js);
            })(window, document, "script", "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev/rainbowRelax.js", "rainbow-relax");

            window.myWidgetConfig = {
              showQuickExit: false,
              donateURL: 'https://www.paypal.com/donate/?hosted_button_id=G5E9W3NZ8D7WW',
              getHelpURL: 'https://www.thetrevorproject.mx/ayuda/',
              width: '500px',
              height: '500px',
              containerId: "rainbow-relax-container",
              cdnBase: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev/assets/",
              audioEnabled: true
            };
          </script>
          ```

          ## Live Demo
          [View Live Widget](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev/)
          EOF

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: widget-release-${{ github.run_number }}
          path: release-artifact/
          retention-days: 30

      - name: Success notification
        run: |
          echo "ðŸš€ Dev deployment successful!"
          echo "Widget is live at: ${{ env.DEV_URL }}"
          echo "Release artifact created: widget-release-${{ github.run_number }}"

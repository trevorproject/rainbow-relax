<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rainbow Relax Widget - Dynamic Test (Auto Port)</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
      }
      .controls {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .controls h2 {
        margin-top: 0;
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
      }
      .control-group {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 15px;
        align-items: center;
      }
      .control-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .control-item label {
        font-weight: bold;
        color: #495057;
        font-size: 14px;
      }
      .control-item input,
      .control-item select {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        min-width: 120px;
      }
      .control-item input:focus,
      .control-item select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }
      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-primary:hover:not(:disabled) {
        background-color: #0056b3;
      }
      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }
      .btn-secondary:hover:not(:disabled) {
        background-color: #545b62;
      }
      .btn-danger {
        background-color: #dc3545;
        color: white;
      }
      .btn-danger:hover:not(:disabled) {
        background-color: #c82333;
      }
      .btn-success {
        background-color: #28a745;
        color: white;
      }
      .btn-success:hover:not(:disabled) {
        background-color: #1e7e34;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .widget-container {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        position: relative;
        transition: all 0.3s ease;
      }
      .widget-container.no-widget::before {
        content: attr(data-info);
        color: #6c757d;
        font-size: 18px;
        font-weight: bold;
      }
      .widget-container:not(.no-widget) {
        border-color: #28a745;
        background-color: #f8fff9;
      }
      .status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
        font-weight: bold;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .port-info {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üåà Rainbow Relax Widget - Dynamic Test (Auto Port Detection)</h1>

      <div class="port-info" id="port-info">
        üîç Detecting Vite dev server port...
      </div>

      <div class="controls">
        <h2>Widget Configuration</h2>

        <div class="control-group">
          <div class="control-item">
            <label for="width">Width:</label>
            <input type="text" id="width" value="600" />
          </div>
          <div class="control-item">
            <label for="height">Height:</label>
            <input type="text" id="height" value="400" />
          </div>
          <div class="control-item">
            <label for="language">Language:</label>
            <select id="language">
              <option value="en">English</option>
              <option value="es">Espa√±ol</option>
            </select>
          </div>
          <div class="control-item">
            <label for="audioEnabled">Audio:</label>
            <select id="audioEnabled">
              <option value="true">Enabled</option>
              <option value="false">Disabled</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <button id="createBtn" class="btn-primary" onclick="createWidget()">
            Create Widget
          </button>
          <button
            id="destroyBtn"
            class="btn-danger"
            onclick="destroyWidget()"
            disabled
          >
            Destroy Widget
          </button>
          <button
            id="updateBtn"
            class="btn-secondary"
            onclick="updateDimensions()"
            disabled
          >
            Update Dimensions
          </button>
          <button id="refreshBtn" class="btn-success" onclick="refreshPage()">
            Refresh Page
          </button>
        </div>
      </div>

      <div
        class="widget-container no-widget"
        id="rainbow-relax-container"
        data-info="No Widget"
      ></div>

      <div class="status info" id="status">
        Ready to create widget. Make sure the Vite dev server is running.
      </div>
    </div>

    <script>
      // Global variables
      let currentPort = null;
      let isWidgetCreated = false;
      let currentWidget = null;
      let widgetContainer = null;

      // Make variables globally accessible for debugging
      window.isWidgetCreated = isWidgetCreated;
      window.currentWidget = currentWidget;
      window.widgetContainer = widgetContainer;
      window.currentPort = currentPort;

      /**
       * Detect the Vite dev server port
       */
      async function detectPort() {
        const commonPorts = [5173, 5174, 5175, 5176, 5177, 5178, 5179, 5180];

        for (const port of commonPorts) {
          try {
            const response = await fetch(
              `http://localhost:${port}/dist-widget/style.css`,
              {
                method: 'HEAD',
                mode: 'no-cors',
              }
            );

            // If we can reach the port, try to load the CSS
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `http://localhost:${port}/dist-widget/style.css`;

            return new Promise((resolve) => {
              link.onload = () => {
                document.head.appendChild(link);
                resolve(port);
              };
              link.onerror = () => {
                resolve(null);
              };
              document.head.appendChild(link);
            });
          } catch (error) {
            continue;
          }
        }

        return null;
      }

      /**
       * Initialize the page with port detection
       */
      async function initializePage() {
        const portInfo = document.getElementById('port-info');
        const status = document.getElementById('status');

        try {
          portInfo.textContent = 'üîç Detecting Vite dev server port...';

          const detectedPort = await detectPort();

          if (detectedPort) {
            currentPort = detectedPort;
            window.currentPort = currentPort;

            portInfo.textContent = `‚úÖ Vite dev server detected on port ${currentPort}`;
            portInfo.className = 'port-info';

            // Load the widget script
            await loadWidgetScript();

            status.textContent = `Ready! Vite dev server running on port ${currentPort}`;
            status.className = 'status success';

            // Check if widget auto-initialized
            checkInitialWidgetState();
          } else {
            portInfo.textContent =
              '‚ùå No Vite dev server found. Please run "npm run dev" first.';
            portInfo.className = 'port-info';
            portInfo.style.backgroundColor = '#f8d7da';
            portInfo.style.color = '#721c24';
            portInfo.style.borderColor = '#f5c6cb';

            status.textContent =
              'Error: No Vite dev server detected. Please start the dev server with "npm run dev"';
            status.className = 'status error';
          }
        } catch (error) {
          portInfo.textContent = `‚ùå Error detecting port: ${error.message}`;
          portInfo.className = 'port-info';
          portInfo.style.backgroundColor = '#f8d7da';
          portInfo.style.color = '#721c24';
          portInfo.style.borderColor = '#f5c6cb';

          status.textContent = `Error: ${error.message}`;
          status.className = 'status error';
        }
      }

      /**
       * Load the widget script dynamically
       */
      async function loadWidgetScript() {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = `http://localhost:${currentPort}/dist-widget/rainbowRelax.js`;
          script.onload = () => {
            console.log('Widget script loaded successfully');
            resolve();
          };
          script.onerror = () => {
            reject(new Error('Failed to load widget script'));
          };
          document.head.appendChild(script);
        });
      }

      /**
       * Check if widget auto-initialized
       */
      function checkInitialWidgetState() {
        const container = document.getElementById('rainbow-relax-container');

        if (container && container.children.length > 0) {
          // Widget was auto-initialized
          isWidgetCreated = true;
          currentWidget = container;
          widgetContainer = container;

          // Update global variables
          window.isWidgetCreated = isWidgetCreated;
          window.currentWidget = currentWidget;
          window.widgetContainer = widgetContainer;

          // Update UI
          updateButtonStates();

          // Get current dimensions from inputs
          const width = parseInt(document.getElementById('width').value);
          const height = parseInt(document.getElementById('height').value);
          const language = document.getElementById('language').value;

          // Style the container
          container.className = 'widget-container';
          container.style.width = width + 'px';
          container.style.height = height + 'px';
          container.style.setProperty('--widget-width', width + 'px');
          container.style.setProperty('--widget-height', height + 'px');
          container.setAttribute(
            'data-info',
            `${width}√ó${height} ${language.toUpperCase()}`
          );

          document.getElementById('status').textContent =
            'Widget auto-initialized successfully!';
          document.getElementById('status').className = 'status success';
        }
      }

      /**
       * Create widget with current configuration
       */
      function createWidget() {
        if (!currentPort) {
          alert('No Vite dev server detected. Please run "npm run dev" first.');
          return;
        }

        if (isWidgetCreated) {
          alert(
            'Widget already created. Destroy it first if you want to recreate.'
          );
          return;
        }

        const width = parseInt(document.getElementById('width').value);
        const height = parseInt(document.getElementById('height').value);
        const language = document.getElementById('language').value;
        const audioEnabled =
          document.getElementById('audioEnabled').value === 'true';

        // Configure the widget
        window.myWidgetConfig = {
          containerId: 'rainbow-relax-container',
          width: width + 'px',
          height: height + 'px',
          language: language,
          audioEnabled: audioEnabled,
          cdnBase: `http://localhost:${currentPort}/dist-widget/`,
          assetBase: `http://localhost:${currentPort}/dist-widget/assets/`,
          audioBase: `http://localhost:${currentPort}/dist-widget/sounds/`,
          showQuickExit: false,
          donateURL: 'https://give.thetrevorproject.org/campaign/716635/donate',
          getHelpURL: 'https://www.thetrevorproject.org/get-help/',
          GTAG: null,
          showConsentBanner: true,
        };

        // Style the container
        widgetContainer = document.getElementById('rainbow-relax-container');
        widgetContainer.className = 'widget-container';
        widgetContainer.style.width = width + 'px';
        widgetContainer.style.height = height + 'px';
        widgetContainer.style.setProperty('--widget-width', width + 'px');
        widgetContainer.style.setProperty('--widget-height', height + 'px');
        widgetContainer.setAttribute(
          'data-info',
          `${width}√ó${height} ${language.toUpperCase()}`
        );

        // Initialize the widget
        if (window.MyWidget && window.MyWidget.init) {
          window.MyWidget.init(window.myWidgetConfig);
          isWidgetCreated = true;
          currentWidget = widgetContainer;

          // Update global variables
          window.isWidgetCreated = isWidgetCreated;
          window.currentWidget = currentWidget;
          window.widgetContainer = widgetContainer;

          updateButtonStates();

          document.getElementById(
            'status'
          ).textContent = `Widget created successfully! ${width}√ó${height} ${language.toUpperCase()}`;
          document.getElementById('status').className = 'status success';
        } else {
          document.getElementById('status').textContent =
            'Error: Widget script not loaded properly';
          document.getElementById('status').className = 'status error';
        }
      }

      /**
       * Destroy the widget
       */
      function destroyWidget() {
        if (!isWidgetCreated) {
          alert('No widget to destroy.');
          return;
        }

        if (window.MyWidget && window.MyWidget.destroy) {
          window.MyWidget.destroy();
        }

        // Reset container
        widgetContainer = document.getElementById('rainbow-relax-container');
        widgetContainer.innerHTML = '';
        widgetContainer.className = 'widget-container no-widget';
        widgetContainer.removeAttribute('data-info');
        widgetContainer.setAttribute('data-info', 'No Widget');

        isWidgetCreated = false;
        currentWidget = null;

        // Update global variables
        window.isWidgetCreated = isWidgetCreated;
        window.currentWidget = currentWidget;
        window.widgetContainer = widgetContainer;

        updateButtonStates();

        document.getElementById('status').textContent =
          'Widget destroyed successfully!';
        document.getElementById('status').className = 'status info';
      }

      /**
       * Update widget dimensions
       */
      function updateDimensions() {
        if (!isWidgetCreated) {
          alert('No widget to update. Create a widget first.');
          return;
        }

        const width = parseInt(document.getElementById('width').value);
        const height = parseInt(document.getElementById('height').value);
        const language = document.getElementById('language').value;

        // Update container styles
        widgetContainer.style.width = width + 'px';
        widgetContainer.style.height = height + 'px';
        widgetContainer.style.setProperty('--widget-width', width + 'px');
        widgetContainer.style.setProperty('--widget-height', height + 'px');
        widgetContainer.setAttribute(
          'data-info',
          `${width}√ó${height} ${language.toUpperCase()}`
        );

        document.getElementById(
          'status'
        ).textContent = `Widget dimensions updated! ${width}√ó${height}`;
        document.getElementById('status').className = 'status success';
      }

      /**
       * Update button states
       */
      function updateButtonStates() {
        document.getElementById('createBtn').disabled = isWidgetCreated;
        document.getElementById('destroyBtn').disabled = !isWidgetCreated;
        document.getElementById('updateBtn').disabled = !isWidgetCreated;
      }

      /**
       * Refresh the page
       */
      function refreshPage() {
        window.location.reload();
      }

      // Initialize the page when it loads
      document.addEventListener('DOMContentLoaded', initializePage);
    </script>
  </body>
</html>
